<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Growth & Proficiency Visualizer</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      background: #f4f6fb;
      color: #1c2430;
    }

    body {
      margin: 0;
      padding: 32px 24px 64px;
      max-width: 1200px;
      margin-inline: auto;
      line-height: 1.5;
    }

    header {
      margin-bottom: 32px;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    header p {
      max-width: 800px;
      color: #4b5563;
    }

    .section {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.08);
      margin-bottom: 24px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .section-header h2 {
      margin: 0;
    }

    .collapse-button {
      border: 1px solid #d1d5db;
      background: #f8fafc;
      border-radius: 999px;
      padding: 4px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      color: #1f2937;
    }

    .collapse-button:hover {
      background: #eef2ff;
    }

    .section p {
      color: #4b5563;
      margin-top: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      overflow: hidden;
    }

    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 4px 6px;
      font-size: 0.9rem;
      box-sizing: border-box;
      text-align: center;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      margin-top: 16px;
    }

    .card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e2e8f0;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 16px;
    }

    .meta label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      font-size: 0.85rem;
      gap: 4px;
      color: #374151;
    }

    .note {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .warning {
      color: #b45309;
      font-weight: 600;
    }

    .toggle {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .hidden {
      display: none;
    }

    .badge {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .heat-low {
      background: #fee2e2;
    }

    .heat-mid {
      background: #fef3c7;
    }

    .heat-high {
      background: #dcfce7;
    }

    .chart-wrapper {
      padding: 16px;
      border: 1px dashed #cbd5f5;
      border-radius: 12px;
      background: #f8fafc;
    }

    footer {
      margin-top: 40px;
      color: #94a3b8;
      font-size: 0.85rem;
      text-align: center;
    }

    .section-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }

    .section-actions button {
      border: 1px solid #cbd5f5;
      background: #eef2ff;
      color: #3730a3;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 600;
    }

    .section-actions button:hover {
      background: #e0e7ff;
    }

    .section-actions input[type="file"] {
      display: none;
    }

    .subtle {
      color: #64748b;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .vertical-header {
      height: 130px;
      vertical-align: bottom;
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .vertical-header span {
      display: inline-block;
      transform: rotate(-90deg);
      transform-origin: center;
      white-space: nowrap;
    }

    #monthly-products-table,
    .proficiency-table {
      table-layout: fixed;
    }

    #monthly-products-table th,
    #monthly-products-table td,
    .proficiency-table th,
    .proficiency-table td {
      padding: 4px;
      font-size: 0.75rem;
    }

    #monthly-products-table th.vertical-header,
    .proficiency-table th.vertical-header {
      width: 36px;
    }

    .proficiency-table th,
    .proficiency-table td {
      font-size: 0.7rem;
      padding: 3px;
    }

    .table-scroll {
      overflow-x: auto;
      max-width: 100%;
    }

    .compact-table {
      width: max-content;
      min-width: 100%;
      margin: 0;
      table-layout: auto;
    }

    .compact-table th,
    .compact-table td {
      padding: 0;
      min-width: 84px;
    }

    .compact-table th:first-child,
    .compact-table td:first-child {
      position: sticky;
      left: 0;
      z-index: 2;
      background: #ffffff;
      min-width: 160px;
      box-shadow: 2px 0 0 #e5e7eb;
    }

    .compact-table thead th:first-child {
      z-index: 3;
      background: #f8fafc;
    }

    .compact-table input[type="number"],
    .compact-table input[type="text"] {
      padding: 0;
      min-width: 72px;
      height: 28px;
    }

    .compact-table .vertical-header {
      min-width: 84px;
    }

    #step-2 input[type="number"],
    #step-3 input[type="number"],
    #step-4 input[type="number"],
    #step-4 select {
      width: 50%;
      margin: 0 auto;
    }

    @media (max-width: 900px) {
      .proficiency-table th,
      .proficiency-table td {
        font-size: 0.65rem;
        padding: 2px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Team Growth &amp; Proficiency Visualizer</h1>
    <p>
      Build a full transformation from quarterly product plans to monthly production, then measure how much of each team
      is still new while they train up to full proficiency. Update any input and the tables + chart will recalculate
      instantly.
    </p>
  </header>

  <section class="section" id="step-1">
    <div class="section-header">
      <h2>1. Current Teams &amp; Staffing by Product Level</h2>
      <button class="collapse-button" type="button" data-target="step-1">Collapse</button>
    </div>
    <div class="section-body">
      <p>
        Capture current headcount plus the staffing required at specific product levels. Product levels are shared
        across every team, while staffing can be non-linear by level.
      </p>
      <table id="team-table">
        <thead>
          <tr>
            <th>Team</th>
            <th>Internal hiring (%)</th>
            <th>
              Current staff for
              <div class="subtle">Products / Quarter</div>
              <input class="current-product-input" type="number" min="0" step="1" value="4" />
            </th>
            <th>
              Staffing for
              <div class="subtle">Products / Quarter</div>
              <input class="product-level-input" type="number" min="0" step="1" value="2" />
            </th>
            <th>
              Staffing for
              <div class="subtle">Products / Quarter</div>
              <input class="product-level-input" type="number" min="0" step="1" value="4" />
            </th>
            <th>
              Staffing for
              <div class="subtle">Products / Quarter</div>
              <input class="product-level-input" type="number" min="0" step="1" value="6" />
            </th>
            <th>
              Staffing for
              <div class="subtle">Products / Quarter</div>
              <input class="product-level-input" type="number" min="0" step="1" value="8" />
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="text" value="Core Platform" /></td>
            <td><input type="number" min="0" max="100" step="1" value="60" /></td>
            <td><input type="number" min="0" value="18" /></td>
            <td><input type="number" min="0" step="1" value="22" /></td>
            <td><input type="number" min="0" step="1" value="28" /></td>
            <td><input type="number" min="0" step="1" value="36" /></td>
            <td><input type="number" min="0" step="1" value="44" /></td>
          </tr>
          <tr>
            <td><input type="text" value="Data Systems" /></td>
            <td><input type="number" min="0" max="100" step="1" value="55" /></td>
            <td><input type="number" min="0" value="12" /></td>
            <td><input type="number" min="0" step="1" value="15" /></td>
            <td><input type="number" min="0" step="1" value="19" /></td>
            <td><input type="number" min="0" step="1" value="24" /></td>
            <td><input type="number" min="0" step="1" value="30" /></td>
          </tr>
          <tr>
            <td><input type="text" value="Client Success" /></td>
            <td><input type="number" min="0" max="100" step="1" value="50" /></td>
            <td><input type="number" min="0" value="15" /></td>
            <td><input type="number" min="0" step="1" value="18" /></td>
            <td><input type="number" min="0" step="1" value="23" /></td>
            <td><input type="number" min="0" step="1" value="29" /></td>
            <td><input type="number" min="0" step="1" value="36" /></td>
          </tr>
        </tbody>
      </table>
      <div class="section-actions">
        <button type="button" id="export-csv">Export CSV</button>
        <button type="button" id="import-csv">Import CSV</button>
        <input type="file" id="csv-file" accept=".csv" />
        <button type="button" id="add-team">Add row</button>
        <button type="button" id="remove-team">Remove row</button>
        <button type="button" id="add-level">Add column</button>
        <button type="button" id="remove-level">Remove column</button>
      </div>
      <p class="note">Tip: Paste from Excel/Sheets directly into the table to fill multiple cells.</p>
      <div class="grid">
        <div class="card">
          <strong>Total New Hires (2026-2028)</strong>
          <div class="note" id="total-hires"></div>
        </div>
        <div class="card">
          <strong>Peak Monthly Headcount</strong>
          <div class="note" id="peak-headcount"></div>
        </div>
        <div class="card">
          <strong>Headcount at Dec 2028</strong>
          <div class="note" id="year-end"></div>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="step-2">
    <div class="section-header">
      <h2>2. Translate Quarterly Products to Monthly Timeline</h2>
      <button class="collapse-button" type="button" data-target="step-2">Collapse</button>
    </div>
    <div class="section-body">
      <p>
        Enter planned production in products per quarter (unit) for each month from 2026 through 2028. These values
        drive the staffing projections below.
      </p>
      <div class="table-scroll">
        <table id="monthly-products-table" class="compact-table">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="meta">
        <span class="badge" id="quarter-balance"></span>
        <span class="note">Quarterly rates are used directly for staffing projections.</span>
      </div>
    </div>
  </section>

  <section class="section" id="step-3">
    <div class="section-header">
      <h2>3. New Hire Training Curve</h2>
      <button class="collapse-button" type="button" data-target="step-3">Collapse</button>
    </div>
    <div class="section-body">
      <p>
        Define how quickly new employees reach full proficiency. This curve is applied to each month of hires.
      </p>
      <div class="table-scroll">
        <table id="training-table" class="compact-table">
        <thead>
          <tr>
            <th>Month Since Hire</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
            <th>8</th>
            <th>9</th>
            <th>10</th>
            <th>11</th>
            <th>12</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Low-Fit Proficiency (%)</td>
            <td><input type="number" min="0" max="100" value="0" /></td>
            <td><input type="number" min="0" max="100" value="18" /></td>
            <td><input type="number" min="0" max="100" value="32" /></td>
            <td><input type="number" min="0" max="100" value="45" /></td>
            <td><input type="number" min="0" max="100" value="55" /></td>
            <td><input type="number" min="0" max="100" value="65" /></td>
            <td><input type="number" min="0" max="100" value="74" /></td>
            <td><input type="number" min="0" max="100" value="82" /></td>
            <td><input type="number" min="0" max="100" value="88" /></td>
            <td><input type="number" min="0" max="100" value="93" /></td>
            <td><input type="number" min="0" max="100" value="97" /></td>
            <td><input type="number" min="0" max="100" value="100" /></td>
          </tr>
          <tr>
            <td>High-Fit Proficiency (%)</td>
            <td><input type="number" min="0" max="100" value="0" /></td>
            <td><input type="number" min="0" max="100" value="25" /></td>
            <td><input type="number" min="0" max="100" value="45" /></td>
            <td><input type="number" min="0" max="100" value="60" /></td>
            <td><input type="number" min="0" max="100" value="70" /></td>
            <td><input type="number" min="0" max="100" value="80" /></td>
            <td><input type="number" min="0" max="100" value="88" /></td>
            <td><input type="number" min="0" max="100" value="92" /></td>
            <td><input type="number" min="0" max="100" value="95" /></td>
            <td><input type="number" min="0" max="100" value="97" /></td>
            <td><input type="number" min="0" max="100" value="99" /></td>
            <td><input type="number" min="0" max="100" value="100" /></td>
          </tr>
        </tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="section" id="step-4">
    <div class="section-header">
      <h2>4. Team Proficiency Over Time</h2>
      <button class="collapse-button" type="button" data-target="step-4">Collapse</button>
    </div>
    <div class="section-body">
      <p>
        Review how much of each team is still new every month. Set a threshold to apply conditional formatting and toggle
        the chart view.
      </p>
      <div class="meta">
        <label>
          Red threshold (%)
          <input type="number" id="threshold-red" min="0" max="100" value="80" />
        </label>
        <label>
          Orange threshold (%)
          <input type="number" id="threshold-orange" min="0" max="100" value="90" />
        </label>
        <label class="toggle">
          View
          <select id="view-toggle">
            <option value="table" selected>Table</option>
            <option value="chart">Chart</option>
          </select>
        </label>
      </div>
      <div class="card" style="margin-top: 16px;">
        <div class="table-scroll" id="proficiency-table"></div>
        <div id="proficiency-chart" class="hidden chart-wrapper">
          <canvas id="chart-canvas" height="120"></canvas>
        </div>
      </div>
    </div>
  </section>

  <footer>Update inputs to explore different growth and training scenarios.</footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const generateMonthLabels = (startYear, endYear) => {
      const labels = [];
      const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      for (let year = startYear; year <= endYear; year += 1) {
        months.forEach((month) => {
          labels.push(`${month} ${year}`);
        });
      }
      return labels;
    };

    const monthLabels = generateMonthLabels(2026, 2028);

    const teamTable = document.getElementById("team-table");
    const trainingTable = document.getElementById("training-table");
    const monthlyProductsBody = document.querySelector("#monthly-products-table tbody");
    const totalHires = document.getElementById("total-hires");
    const peakHeadcount = document.getElementById("peak-headcount");
    const yearEnd = document.getElementById("year-end");
    const quarterBalance = document.getElementById("quarter-balance");
    const thresholdRedInput = document.getElementById("threshold-red");
    const thresholdOrangeInput = document.getElementById("threshold-orange");
    const viewToggle = document.getElementById("view-toggle");
    const proficiencyTable = document.getElementById("proficiency-table");
    const proficiencyChart = document.getElementById("proficiency-chart");
    const chartCanvas = document.getElementById("chart-canvas");
    const exportCsvButton = document.getElementById("export-csv");
    const importCsvButton = document.getElementById("import-csv");
    const csvFileInput = document.getElementById("csv-file");
    const addTeamButton = document.getElementById("add-team");
    const removeTeamButton = document.getElementById("remove-team");
    const addLevelButton = document.getElementById("add-level");
    const removeLevelButton = document.getElementById("remove-level");
    const currentProductInput = document.querySelector(".current-product-input");

    let chartInstance = null;

    const formatNumber = (value, decimals = 0) => {
      if (!Number.isFinite(value)) {
        return "-";
      }
      return value.toLocaleString(undefined, {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals,
      });
    };

    const buildMonthlyProductsTable = () => {
      const body = monthlyProductsBody;
      const defaultRates = monthLabels.map((_, index) => (index < 12 ? 6 : index < 24 ? 7 : 8));
      body.innerHTML = `
        <tr>
          <td class="subtle">Rate</td>
          ${defaultRates
            .map(
              (value) =>
                `<td><input class="monthly-product-input" type="number" min="0" step="1" value="${value}" /></td>`
            )
            .join("")}
        </tr>
      `;
    };

    const getProductLevels = () =>
      Array.from(document.querySelectorAll(".product-level-input")).map((input) => Number(input.value) || 0);

    const parseTeams = () => {
      const rows = Array.from(teamTable.tBodies[0].rows);
      const levelCount = getProductLevels().length;
      return rows.map((row) => {
        const inputs = row.querySelectorAll("input");
        const staffingLevels = Array.from(inputs)
          .slice(3, 3 + levelCount)
          .map((input) => Number(input.value) || 0);
        return {
          name: inputs[0].value || "Team",
          highFitShare: Number(inputs[1].value) || 0,
          current: Number(inputs[2].value) || 0,
          staffingLevels,
        };
      });
    };

    const parseMonthlyProducts = () =>
      Array.from(monthlyProductsBody.querySelectorAll("input")).map((input) => Number(input.value) || 0);

    const parseTrainingCurve = () => {
      const rows = Array.from(trainingTable.tBodies[0].rows);
      const parseRow = (row) =>
        Array.from(row.querySelectorAll("input")).map((input) => (Number(input.value) || 0) / 100);
      return {
        lowFit: parseRow(rows[0]),
        highFit: parseRow(rows[1]),
      };
    };

    const estimateStaffing = (productCount, productLevels, staffingLevels) => {
      if (productCount <= 0 || productLevels.length === 0) {
        return 0;
      }
      const pairs = productLevels
        .map((level, index) => ({
          level: Number(level) || 0,
          staff: Number(staffingLevels[index]) || 0,
        }))
        .sort((a, b) => a.level - b.level);

      if (productCount <= pairs[0].level) {
        return pairs[0].staff;
      }

      for (let index = 1; index < pairs.length; index += 1) {
        const previous = pairs[index - 1];
        const current = pairs[index];
        if (productCount <= current.level) {
          const span = current.level - previous.level;
          const ratio = span === 0 ? 0 : (productCount - previous.level) / span;
          return previous.staff + ratio * (current.staff - previous.staff);
        }
      }

      return pairs[pairs.length - 1].staff;
    };

    const computeMonthlyStaffing = (teams, productLevels, monthlyProducts) =>
      teams.map((team) => {
        let totalHeadcount = team.current;
        const hiresMonthly = [];
        const totalMonthlyHeadcount = [];
        monthlyProducts.forEach((productCount) => {
          const required = Math.max(
            team.current,
            estimateStaffing(productCount, productLevels, team.staffingLevels)
          );
          const hires = Math.max(required - totalHeadcount, 0);
          totalHeadcount += hires;
          hiresMonthly.push(hires);
          totalMonthlyHeadcount.push(totalHeadcount);
        });
        return {
          ...team,
          hiresMonthly,
          totalMonthlyHeadcount,
        };
      });

    const computeProficiencyTimeline = (teams, trainingCurve) =>
      teams.map((team) => {
        const totalMonthlyHeadcount = [];
        const proficiencyMonthly = [];

        for (let monthIndex = 0; monthIndex < monthLabels.length; monthIndex += 1) {
          let totalHeadcount = team.current;
          let effectiveCapacity = team.current;

          for (let hireMonth = 0; hireMonth <= monthIndex; hireMonth += 1) {
            const hires = team.hiresMonthly[hireMonth] || 0;
            totalHeadcount += hires;
            const trainingIndex = monthIndex - hireMonth;
            const highFitShare = Math.min(Math.max(team.highFitShare, 0), 100) / 100;
            const highFitHires = hires * highFitShare;
            const lowFitHires = hires - highFitHires;
            const highFitRate = trainingCurve.highFit[trainingIndex] ?? 1;
            const lowFitRate = trainingCurve.lowFit[trainingIndex] ?? 1;
            effectiveCapacity += highFitHires * highFitRate + lowFitHires * lowFitRate;
          }

          totalMonthlyHeadcount.push(totalHeadcount);
          const proficiency = totalHeadcount === 0 ? 1 : effectiveCapacity / totalHeadcount;
          proficiencyMonthly.push(proficiency);
        }

        return {
          ...team,
          totalMonthlyHeadcount,
          proficiencyMonthly,
        };
      });

    const updateStaffingSummary = (teams) => {
      const monthCount = monthLabels.length;
      const monthlyTotals = Array(monthCount).fill(0);
      let totalHiresValue = 0;

      teams.forEach((team) => {
        team.hiresMonthly.forEach((hires, index) => {
          totalHiresValue += hires;
          monthlyTotals[index] += team.totalMonthlyHeadcount[index] || 0;
        });
      });

      const peak = monthlyTotals.length ? Math.max(...monthlyTotals) : 0;
      const endValue = monthlyTotals[monthCount - 1] || 0;

      totalHires.textContent = `${formatNumber(totalHiresValue)} hires`;
      peakHeadcount.textContent = `${formatNumber(peak)} people`;
      yearEnd.textContent = `${formatNumber(endValue)} people`;
    };

    const updateQuarterBalance = (monthlyProducts) => {
      const average = monthlyProducts.length
        ? monthlyProducts.reduce((sum, value) => sum + value, 0) / monthlyProducts.length
        : 0;
      quarterBalance.textContent = `Average products/quarter: ${formatNumber(average)}`;
      quarterBalance.className = "badge";
    };

    const getHeatClass = (value, redThreshold, orangeThreshold) => {
      if (value < redThreshold) return "heat-low";
      if (value < orangeThreshold) return "heat-mid";
      return "heat-high";
    };

    const renderProficiencyTable = (teams, redThreshold, orangeThreshold) => {
      const header = `
        <table class="proficiency-table compact-table">
          <tbody>
      `;

      const bodyRows = teams.map((team) => {
        const cells = team.proficiencyMonthly.map((value) => {
          const className = getHeatClass(value, redThreshold, orangeThreshold);
          return `<td class="${className}">${formatNumber(value * 100)}%</td>`;
        });
        return `<tr><td>${team.name}</td>${cells.join("")}</tr>`;
      });

      proficiencyTable.innerHTML = `${header}${bodyRows.join("")}</tbody></table>`;
    };

    const renderChart = (teams) => {
      const datasets = teams.map((team, index) => {
        const colors = ["#2563eb", "#0f766e", "#d97706", "#9333ea", "#dc2626"];
        return {
          label: team.name,
          data: team.proficiencyMonthly.map((value) => Math.round(value * 1000) / 10),
          borderColor: colors[index % colors.length],
          backgroundColor: "transparent",
          tension: 0.3,
        };
      });

      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(chartCanvas, {
        type: "line",
        data: {
          labels: monthLabels,
          datasets,
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
            },
          },
          scales: {
            y: {
              min: 0,
              max: 100,
              title: {
                display: true,
                text: "Proficiency (%)",
              },
            },
          },
        },
      });
    };

    const updateViewToggle = () => {
      const isChart = viewToggle.value === "chart";
      proficiencyTable.classList.toggle("hidden", isChart);
      proficiencyChart.classList.toggle("hidden", !isChart);
    };

    const recompute = () => {
      const teams = parseTeams();
      const productLevels = getProductLevels();
      const monthlyProducts = parseMonthlyProducts();
      updateQuarterBalance(monthlyProducts);

      const staffedTeams = computeMonthlyStaffing(teams, productLevels, monthlyProducts);
      updateStaffingSummary(staffedTeams);

      const trainingCurve = parseTrainingCurve();
      const proficiencyTeams = computeProficiencyTimeline(staffedTeams, trainingCurve);

      const redThreshold = (Number(thresholdRedInput.value) || 0) / 100;
      const orangeThreshold = (Number(thresholdOrangeInput.value) || 0) / 100;
      const sortedRed = Math.min(redThreshold, orangeThreshold);
      const sortedOrange = Math.max(redThreshold, orangeThreshold);
      renderProficiencyTable(proficiencyTeams, sortedRed, sortedOrange);
      renderChart(proficiencyTeams);
      updateViewToggle();
    };

    const bindInputs = () => {
      document.querySelectorAll("input, select").forEach((input) => {
        if (!input.dataset.bound) {
          input.addEventListener("input", recompute);
          input.dataset.bound = "true";
        }
      });
      if (!viewToggle.dataset.bound) {
        viewToggle.addEventListener("change", updateViewToggle);
        viewToggle.dataset.bound = "true";
      }
    };

    const createTeamRow = (levelCount) => {
      const row = document.createElement("tr");
      const staffingCells = Array.from({ length: levelCount })
        .map(() => `<td><input type="number" min="0" step="1" value="0" /></td>`)
        .join("");
      row.innerHTML = `
        <td><input type="text" value="" /></td>
        <td><input type="number" min="0" max="100" step="1" value="50" /></td>
        <td><input type="number" min="0" value="0" /></td>
        ${staffingCells}
      `;
      return row;
    };

    const ensureTeamRowCount = (count) => {
      const body = teamTable.tBodies[0];
      const levelCount = getProductLevels().length;
      while (body.rows.length < count) {
        body.appendChild(createTeamRow(levelCount));
      }
      while (body.rows.length > count) {
        body.deleteRow(body.rows.length - 1);
      }
    };

    const addTeamRow = () => {
      const body = teamTable.tBodies[0];
      const levelCount = getProductLevels().length;
      body.appendChild(createTeamRow(levelCount));
      bindInputs();
      recompute();
    };

    const removeTeamRow = () => {
      const body = teamTable.tBodies[0];
      if (body.rows.length <= 1) {
        return;
      }
      body.deleteRow(body.rows.length - 1);
      recompute();
    };

    const csvEscape = (value) => {
      const stringValue = String(value ?? "");
      if (/[",\n]/.test(stringValue)) {
        return `"${stringValue.replace(/"/g, "\"\"")}"`;
      }
      return stringValue;
    };

    const parseCsv = (text) => {
      const rows = [];
      let row = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i += 1) {
        const char = text[i];
        const next = text[i + 1];
        if (char === "\"" && inQuotes && next === "\"") {
          current += "\"";
          i += 1;
        } else if (char === "\"") {
          inQuotes = !inQuotes;
        } else if (char === "," && !inQuotes) {
          row.push(current);
          current = "";
        } else if (char === "\n" && !inQuotes) {
          row.push(current);
          rows.push(row);
          row = [];
          current = "";
        } else if (char !== "\r") {
          current += char;
        }
      }
      if (current.length || row.length) {
        row.push(current);
        rows.push(row);
      }
      return rows;
    };

    const exportCsv = () => {
      const productLevels = getProductLevels();
      const currentProductLevel = Number(currentProductInput?.value) || 0;
      const header = [
        "Team",
        "Internal hiring (%)",
        `Current staff @ ${currentProductLevel} products/qtr`,
        ...productLevels.map((level) => `Staff needed @ ${level} products/qtr`),
      ];
      const rows = [header];
      Array.from(teamTable.tBodies[0].rows).forEach((row) => {
        const inputs = row.querySelectorAll("input");
        rows.push(Array.from(inputs).map((input) => input.value));
      });
      const csvContent = rows.map((row) => row.map(csvEscape).join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "team-staffing.csv";
      link.click();
      URL.revokeObjectURL(url);
    };

    const importCsv = (file) => {
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        const rows = parseCsv(reader.result || "").filter((row) => row.some((cell) => cell.trim() !== ""));
        if (rows.length === 0) {
          return;
        }
        const header = rows[0];
        const requiredLevels = Math.max(0, header.length - 3);
        const currentLevels = getProductLevels().length;
        if (requiredLevels > currentLevels) {
          for (let i = currentLevels; i < requiredLevels; i += 1) {
            addProductLevelColumn(0);
          }
        }
        const productLevelInputs = Array.from(document.querySelectorAll(".product-level-input"));
        header.slice(3).forEach((cell, index) => {
          const match = cell.match(/([0-9]+(?:\.[0-9]+)?)/);
          if (match && productLevelInputs[index]) {
            productLevelInputs[index].value = match[1];
          }
        });
        const currentMatch = header[1]?.match(/([0-9]+(?:\.[0-9]+)?)/);
        if (currentMatch && currentProductInput) {
          currentProductInput.value = currentMatch[1];
        }
        const dataRows = rows.slice(1);
        ensureTeamRowCount(dataRows.length);
        const levelCount = getProductLevels().length;
        dataRows.forEach((dataRow, rowIndex) => {
          const row = teamTable.tBodies[0].rows[rowIndex];
          const inputs = row.querySelectorAll("input");
          const values = dataRow.slice(0, 3 + levelCount);
          values.forEach((value, index) => {
            if (inputs[index]) {
              inputs[index].value = value;
            }
          });
        });
        bindInputs();
        recompute();
      };
      reader.readAsText(file);
    };

    const bindSectionToggles = () => {
      document.querySelectorAll(".collapse-button").forEach((button) => {
        const section = button.closest(".section");
        const body = section.querySelector(".section-body");
        button.addEventListener("click", () => {
          const isHidden = body.classList.toggle("hidden");
          button.textContent = isHidden ? "Expand" : "Collapse";
          button.setAttribute("aria-expanded", String(!isHidden));
        });
      });
    };

    const addProductLevelColumn = (levelValue = 0) => {
      const headerRow = teamTable.tHead.rows[0];
      const th = document.createElement("th");
      th.innerHTML = `
        Staffing for
        <div class="subtle">Products / Quarter</div>
        <input class="product-level-input" type="number" min="0" step="1" value="${levelValue}" />
      `;
      headerRow.appendChild(th);
      Array.from(teamTable.tBodies[0].rows).forEach((row) => {
        const cell = document.createElement("td");
        cell.innerHTML = `<input type="number" min="0" step="1" value="0" />`;
        row.appendChild(cell);
      });
      bindInputs();
      recompute();
    };

    const removeProductLevelColumn = () => {
      const headerRow = teamTable.tHead.rows[0];
      const productInputs = headerRow.querySelectorAll(".product-level-input");
      if (productInputs.length <= 1) {
        return;
      }
      headerRow.deleteCell(headerRow.cells.length - 1);
      Array.from(teamTable.tBodies[0].rows).forEach((row) => {
        row.deleteCell(row.cells.length - 1);
      });
      bindInputs();
      recompute();
    };

    const getTeamInputMatrix = () =>
      Array.from(teamTable.tBodies[0].rows).map((row) => Array.from(row.querySelectorAll("input")));

    const handleTeamTablePaste = (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement)) {
        return;
      }
      const clipboardText = event.clipboardData?.getData("text");
      if (!clipboardText || !clipboardText.includes("\t")) {
        return;
      }
      event.preventDefault();
      const rows = clipboardText
        .split(/\r?\n/)
        .filter((row) => row.length)
        .map((row) => row.split("\t"));
      const matrix = getTeamInputMatrix();
      let startRow = -1;
      let startCol = -1;
      matrix.forEach((rowInputs, rowIndex) => {
        rowInputs.forEach((input, colIndex) => {
          if (input === target) {
            startRow = rowIndex;
            startCol = colIndex;
          }
        });
      });
      if (startRow === -1 || startCol === -1) {
        return;
      }
      rows.forEach((rowValues, rowOffset) => {
        const rowInputs = matrix[startRow + rowOffset];
        if (!rowInputs) {
          return;
        }
        rowValues.forEach((value, colOffset) => {
          const input = rowInputs[startCol + colOffset];
          if (input) {
            input.value = value.trim();
          }
        });
      });
      recompute();
    };

    exportCsvButton.addEventListener("click", exportCsv);
    importCsvButton.addEventListener("click", () => csvFileInput.click());
    csvFileInput.addEventListener("change", (event) => {
      importCsv(event.target.files[0]);
      csvFileInput.value = "";
    });
    addLevelButton.addEventListener("click", () => {
      addProductLevelColumn(0);
    });
    removeLevelButton.addEventListener("click", removeProductLevelColumn);
    addTeamButton.addEventListener("click", addTeamRow);
    removeTeamButton.addEventListener("click", removeTeamRow);
    teamTable.addEventListener("paste", handleTeamTablePaste);

    buildMonthlyProductsTable();
    bindSectionToggles();
    bindInputs();
    recompute();
  </script>
</body>
</html>
